name: Deploy Next.js site to Pages

on:
  # Cloudflare Pages を優先するため GitHub Pages の自動デプロイは一旦無効化
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: pages
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest
      - name: Setup Pages
        uses: actions/configure-pages@v5
        with:
          static_site_generator: next
      - name: Restore cache
        uses: actions/cache@v4
        with:
          path: |
            .next/cache
          key: ${{ runner.os }}-nextjs-${{ hashFiles('bun.lockb') }}-${{ hashFiles('**.[jt]s', '**.[jt]sx') }}
          restore-keys: |
            ${{ runner.os }}-nextjs-${{ hashFiles('bun.lockb') }}-
      - name: Install dependencies
        run: bun install --frozen-lockfile
      - name: Build with Next.js
        env:
          SITE_URL: ${{ secrets.SITE_URL || (endsWith(github.event.repository.name, '.github.io') && format('https://{0}', github.event.repository.name) || format('https://{0}.github.io/{1}', github.repository_owner, github.event.repository.name)) }}
          # NOTE: GitHub Expressions で "A && '' || B" は左辺が空文字だと B にフォールバックしてしまう。
          # そのためユーザー/Org ページの場合は '/' を渡し、アプリ側で '' に正規化する。
          NEXT_PUBLIC_BASE_PATH: ${{ endsWith(github.event.repository.name, '.github.io') && '/' || format('/{0}', github.event.repository.name) }}
          NEXT_PUBLIC_ASSET_VERSION: ${{ github.sha }}
          INCLUDE_DRAFTS: 'false'
        run: bun run build
      - name: Build Storybook
        env:
          HOME: .storybook-home
          STORYBOOK_DISABLE_TELEMETRY: '1'
          STORYBOOK_DISABLE_GLOBAL_SETTINGS: 'true'
          STORYBOOK_DISABLE_VERSION_CHECK: 'true'
        run: |
          bun run storybook:build
          mkdir -p out/storybook
          cp -R storybook-static/* out/storybook
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./out

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
